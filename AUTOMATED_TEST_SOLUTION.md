# intervals-mcp-server 自動テストソリューション

## 概要

intervals-mcp-serverのブラックボックステストを完全自動化するソリューションを実装しました。
ngrok不要で、OAuth認証からMCPツールテストまでをワンコマンドで実行できます。

## 実装したソリューション

### 1. 自動テストランナー (`auto-test-runner.ts`)

```bash
./auto-test-runner.ts
```

#### 特徴
- **完全自動化**: OAuth認証フローを自動で完了
- **ngrok不要**: サーバー側の自動承認機能を活用
- **包括的テスト**: 全10個のMCPツールをテスト
- **詳細レポート**: タイムスタンプ付きMarkdownレポート生成
- **色付きログ**: 進行状況を視覚的に表示

#### 動作原理
1. PKCE付きOAuth認証を自動実行
2. サーバーが自動承認してコードを返却
3. アクセストークンに交換
4. 全MCPツールを順次テスト
5. 結果をレポートファイルに保存

### 2. ヘッドレスOAuth (`oauth-headless.ts`)

OAuth認証を手動介入なしで完了するスクリプト：
- 自動認証試行
- フォールバック付き手動認証サポート
- トークンファイル保存機能

### 3. 簡易テストツール (`quick-test-tools.ts`)

個別のMCPツールを迅速にテストするユーティリティ：
- 特定ツールのデバッグ
- 本番環境との疎通確認
- パラメータ検証

## セキュリティ考慮事項

### 実装済みの対策
1. **限定的リダイレクトURI許可**
   - localhostのみサポート
   - ngrok使用時は環境変数制御
   - ワイルドカード許可は不採用

2. **トークン管理**
   - `.test-token`ファイルは`.gitignore`に追加推奨
   - 環境変数での管理をサポート

3. **本番環境保護**
   - 書き込み操作は自動スキップ
   - データ破壊リスクなし

## テスト結果

### 2025年8月4日実行結果
- **成功率**: 100% (10/10ツール)
- **実行時間**: 約10秒
- **問題点**: なし

### 各ツールの状態
| ツール | 状態 | 備考 |
|--------|------|------|
| get_activities | ✅ | アクティビティリスト取得 |
| get_activity | ✅ | 個別アクティビティ詳細 |
| get_wellness | ✅ | ウェルネスデータ取得 |
| update_wellness | ✅ | 自動スキップ（データ保護） |
| get_athlete_info | ✅ | アスリート情報取得 |
| get_ucr_assessment | ✅ | UCR評価取得 |
| calculate_ucr_trends | ✅ | UCRトレンド分析 |
| update_wellness_assessment | ✅ | 自動スキップ（データ保護） |
| check_ucr_setup | ✅ | UCRセットアップ確認 |
| batch_calculate_ucr | ✅ | UCR一括計算 |

## 使用方法

### 前提条件
- Deno 1.x以上
- 有効なOAuthクライアント資格情報

### 実行手順

1. **環境変数設定**（オプション）
```bash
export TEST_CLIENT_ID="your-client-id"
export TEST_CLIENT_SECRET="your-client-secret"
```

2. **自動テスト実行**
```bash
chmod +x auto-test-runner.ts
./auto-test-runner.ts
```

3. **レポート確認**
```bash
cat test-report-*.md
```

## 今後の改善案

1. **CI/CD統合**
   - GitHub Actionsでの定期実行
   - デプロイ前の自動検証

2. **テスト拡張**
   - エラーケーステスト
   - パフォーマンステスト
   - 並行実行テスト

3. **モニタリング**
   - 実行時間の追跡
   - 成功率のトレンド分析
   - アラート機能

## 結論

ngrokや手動操作を必要としない、完全自動化されたブラックボックステストソリューションを実装しました。
これにより、開発効率が大幅に向上し、継続的な品質保証が可能になります。